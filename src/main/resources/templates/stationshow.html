<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      >
<head lang="en">

    <title>Spring Framework Guru</title>

    <!--/*/ <th:block th:include="fragments/headerinc :: head"></th:block> /*/-->
</head>
<body>
<div class="container">
    <h2 th:text="${station.name}"></h2>
    <div>
        <form class="form-horizontal">
            <div class="form-group">
                <label class="col-sm-2 control-label">ИД:</label>
                <div class="col-sm-10">
                    <p class="form-control-static" th:text="${station.id}">Product Id</p></div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Именование:</label>
                <div class="col-sm-10">
                    <p class="form-control-static" th:text="${station.name}">description</p>
                </div>
            </div>
            <script th:inline="javascript">
                //<![CDATA[
                window.charts = [];
                $(function () {
                    var that = this;
                    that.updateChart = function (data) {
                            for(var i=0;i<window.charts.length;i++){
                                if(!data.sensorId == window.charts[i].sensorId)
                                    continue;
                                var chart = window.charts[i];
                            chart.dps.push({
                                x: new Date(data.time),
                                y: parseFloat(data.data)
                            });
                            if (chart.dps.length > 500) {
                                chart.dps.shift();
                            }
                            chart.render();
                            }
                    };
                    var socket = new SockJS('/gs-guide-websocket');
                    that.stompClient = Stomp.over(socket);
                    that.stompClient.connect({}, function (frame) {
                        console.log('Connected: ' + frame);
                        that.stompClient.subscribe('/topic/greetings', function (message) {
                            var msg = JSON.parse(message.body);
                            $.each(msg, function(index, data){
                                that.updateChart(data);
                            });
                        });
                    });
                    setInterval(function(){
                        that.stompClient.send("/app/hello", {}, JSON.stringify({'name': ''}));
                    }, 200);

                });
                //]]>
            </script>
            <div class="form-group" th:each="sensor : ${station.sensors}">
                <div style="height: 500px;" th:id="'chart-' + ${sensor.id}" >
                </div>
                <script th:inline="javascript">
                    //<![CDATA[
                    $(function(){

                        var dps = [];

                        var chart = new CanvasJS.Chart("chart-[[${sensor.id}]]", {
                            title: {
                                text: "[[${sensor.sensorType.name}]]"
                            },
                            data: [{
                                type: "line",
                                dataPoints: dps
                            }],
                            axisY: {
                                title: "[[${sensor.sensorType.sensorKind.toString()}]]]",
                            },
                            axisX: {
                                valueFormatString: "HH:mm:ss",
                                title: "Время",
                            },
                        });
                        chart.dps = dps;
                        chart.sensorId = "[[${sensor.id}]]";
                        window.charts.push(chart);
                    });
                    //]]>
                </script>
            </div>
            <!--<div class="form-group">-->
                <!--<label class="col-sm-2 control-label">Image Url:</label>-->
                <!--<div class="col-sm-10">-->
                    <!--<p class="form-control-static" th:text="${station.imageUrl}">url....</p>-->
                <!--</div>-->
            <!--</div>-->
        </form>
    </div>
</div>

</body>
</html>